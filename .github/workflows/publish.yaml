name: "Publish"

on:
  workflow_call:
    inputs:
      env-name:
        description: "Environment Name"
        type: string
        default: "pypi"
      env-url:
        description: "Environment URL"
        type: string
        default: ""
      repository-url:
        description: "Build Path"
        type: string
        default: "https://upload.pypi.org/legacy/"
      package-name:
        description: "Package Name"
        type: string
        required: true
      name:
        description: "Artifact Name"
        type: string
        required: true
      path:
        description: "Build Path"
        type: string
        default: "dist"

env:
  url: ${{ inputs.env-url || format('https://pypi.org/p/{0}', inputs.name) }}

jobs:
  publish:
    name: "Publish"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: write
      id-token: write

    environment:
      name: ${{ inputs.env-name }}
      url: ${{ env.url }}

    steps:
      - name: "Debug"
        run: |
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "inputs.repository-url: ${{ inputs.repository-url }}"
          echo "inputs.package-name: ${{ inputs.package-name }}"
          echo "inputs.env-name: ${{ inputs.env-name }}"
          echo "inputs.env-url: ${{ inputs.env-url }}"
          echo "url: ${{ env.url }}"
          echo "inputs.name: ${{ inputs.name }}"
          echo "inputs.path: ${{ inputs.path }}"

      - name: "Download Artifact"
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.name }}
          path: ${{ inputs.path }}

      - name: "Verify Artifacts"
        env:
          path: ${{ inputs.path }}
          tag: ${{ github.ref_name }}
        run: |
          ls -lAh "${path}"/*
          results="$(ls -lAh "${path}"/* | awk '{print $9" - "$5}')"
          md="Artifacts:\n\`\`\`text\n${results}\n\`\`\`"
          echo -e "${md}" >> "$GITHUB_STEP_SUMMARY"
          name="$(echo ${{ inputs.package-name }} | sed 's/\-/\_/g')"
          echo "Verification String: '${name}-${tag}-'"
          find "${path}" -type f | grep -- "${name}-${tag}-" > /dev/null

      - name: "Publish to PyPI"
        id: publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          repository-url: ${{ inputs.repository-url }}
          #attestations: false

      - name: "Summary"
        if: ${{ always() }}
        env:
          tag: ${{ github.ref_name }}
          url: ${{ env.url }}
          repository-url: ${{ inputs.repository-url }}
        run: |
          if [ "${{ steps.publish.outcome }}" == "success" ];then
            markdown="ðŸŽ‰ Published Version: \`${tag}\`\n\n[${url}](${url})\n\n"
          else
            markdown="â›” Error Publishing Version: \`${tag}\`\n\n"
          fi
          markdown+="Repository URL: \`${repository-url}\`"
          echo -e "${markdown}" >> "$GITHUB_STEP_SUMMARY"

      - name: "Send Notification"
        if: ${{ !cancelled() }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          description: |
            - ${{ env.url }}
            - ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
